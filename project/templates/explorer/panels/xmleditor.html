{% load toolbar_tags %}

{% toolbar %}
<div class="iframe-container" style="position: absolute; top: 48px; left:0px; right:0px; bottom: 0px;">
	<textarea name="text">{{ text }}</textarea>
</div>

<script type="text/javascript" charset="utf-8">
(function() {
    function xmleditor_onload(event, panel) {
        var textareaId = 'xmleditor-' + Math.ceil(Math.random() * 1000000000);
        $('textarea', panel).attr('id', textareaId);
        var editor = CodeMirror.fromTextArea(textareaId, {
            parserfile: 'parsexml.js',
            path: "/static/js/codemirror/",
            stylesheet: "/static/css/xmlcolors.css",
            parserConfig: {useHTMLKludges: false},
            onChange: function() {
                $(document).trigger('panel:contentChanged', panel);
            },
            initCallback: function(editor) {
                // Toolbar
                $('.toolbar-tabs li', panel).click(function() {
                    var id = $(this).attr('p:button-list');
                    $('.toolbar-tabs li', panel).removeClass('active');
                    $(this).addClass('active');
                    if (!$('.' + id, panel).is(':visible')) {
                        $('.toolbar-buttons ol', panel).not('#' + id).hide();
                        $('.' + id, panel).show();
                    }
                })
                
                var keys = {};
                $('.toolbar-buttons li', panel).each(function() {
                    var tag = $(this).attr('p:tag');
                    var handler = function() {
                        var text = editor.selection();
                        console.log(editor, editor.frame);
                        editor.replaceSelection('<' + tag + '>' + text + '</' + tag + '>');
                        if (text.length == 0) {
                            var pos = editor.cursorPosition();
                            editor.selectLines(pos.line, pos.character + tag.length + 2);
                        }
                        $(document).trigger('panel:contentChanged', panel);
                    }
                    if ($(this).attr('p:key')) {
                        keys[$(this).attr('p:key')] = handler;
                    }
                    $(this).click(handler)
                });

                editor.grabKeys(function(event) { 
                    if (keys[event.keyCode]) {
                        keys[event.keyCode]();
                    }
                }, function(event) { return event.altKey && keys[event.keyCode]; });
            }
        })
        
        $(editor.frame).css({width: '100%', height: '100%'});
        
        $('#toolbar-buttons li').wTooltip({
            delay: 1000, 
            style: {
                border: "1px solid #7F7D67",
                opacity: 0.9, 
                background: "#FBFBC6", 
                padding: "1px",
                fontSize: "12px",
            }
        });
    };
    
    function xmleditor_onunload(event, panel) {}
    
    panel(xmleditor_onload, xmleditor_onunload);
})();
</script>
